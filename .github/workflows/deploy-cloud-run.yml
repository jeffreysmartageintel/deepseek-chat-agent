name: "DeepSeek Chat Agent - Build & Deploy to Google Cloud Run"

# å·¥ä½œæµå˜é‡é…ç½®
env:
  # Lark é€šçŸ¥é…ç½®å˜é‡
  LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }} # Lark Webhook URLï¼ˆéœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®ï¼‰

  # Google Cloud é…ç½®å˜é‡
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: deepseek-chat-agent
  REGION: us-central1

  # Google Artifact Registry é…ç½®å˜é‡ï¼ˆå¿…éœ€ï¼‰
  ARTIFACT_REGISTRY_URL: ${{ secrets.ARTIFACTORY_URL }} # Google Artifact Registry URLï¼Œä¾‹å¦‚: us-central1-docker.pkg.dev/project-id/repository-name

  # æ„å»ºé…ç½®å˜é‡
  CHECK_TIME_BJ: "19:30" # æ£€æŸ¥ push çš„æ—¶é—´ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 19:30ï¼‰

  # DeepSeek API é…ç½®å˜é‡
  DEEPSEEK_API_BASE: ${{ secrets.DEEPSEEK_API_BASE || 'https://api.deepseek.com/v1' }} # DeepSeek API Base URLï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å®˜æ–¹ APIï¼‰

on:
  schedule:
    # æ¯å¤© UTC 11:30 æ‰§è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´ 19:30ï¼‰
    # åŒ—äº¬æ—¶é—´ = UTC + 8å°æ—¶ï¼Œæ‰€ä»¥ 19:30 BJ = 11:30 UTC
    - cron: "30 11 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ push æ£€æŸ¥ï¼‰"
        required: false
        default: false
        type: boolean
      approve_deployment:
        description: "æ‰¹å‡†éƒ¨ç½²åˆ° Cloud Runï¼ˆä»…åœ¨æ„å»ºå®Œæˆåä½¿ç”¨ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: read
  checks: read
  id-token: write

jobs:
  check-push:
    name: "æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç  Push"
    runs-on: ubuntu-latest
    outputs:
      has_push: ${{ steps.check.outputs.has_push }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•

      - name: æ£€æŸ¥ä»Šå¤© 00:00-19:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹é—´æ˜¯å¦æœ‰ Push
        id: check
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTCï¼‰
          CURRENT_DATE_UTC=$(date -u +%Y-%m-%d)
          CURRENT_TIME_UTC=$(date -u +%H:%M)
          CHECK_TIME_BJ="${{ env.CHECK_TIME_BJ }}"  # åŒ—äº¬æ—¶é—´ 19:30

          # è®¡ç®—åŒ—äº¬æ—¶é—´çš„å½“å‰æ—¥æœŸå’Œæ—¶é—´
          CURRENT_DATE_BJ=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          CURRENT_TIME_BJ=$(TZ='Asia/Shanghai' date +%H:%M)

          echo "=========================================="
          echo "Push æ£€æŸ¥ä¿¡æ¯"
          echo "=========================================="
          echo "å½“å‰ UTC æ—¶é—´: $CURRENT_DATE_UTC $CURRENT_TIME_UTC"
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $CURRENT_DATE_BJ $CURRENT_TIME_BJ"
          echo "æ£€æŸ¥æ—¶é—´ç‚¹ (åŒ—äº¬æ—¶é—´): $CHECK_TIME_BJ"
          echo "Workflow è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å¼ºåˆ¶æ„å»ºå‚æ•°: ${{ github.event.inputs.force_build }}"
          echo ""

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†æ‰¹å‡†éƒ¨ç½²ï¼Œè·³è¿‡ push æ£€æŸ¥ï¼ˆè¿™æ˜¯ç”¨äºæ‰¹å‡†éƒ¨ç½²çš„ï¼‰
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.approve_deployment }}" == "true" ]; then
            echo "=========================================="
            echo "æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²è§¦å‘"
            echo "=========================================="
            echo "âœ… è¿™æ˜¯æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²çš„è§¦å‘ï¼Œè·³è¿‡ push æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†å¼ºåˆ¶æ„å»ºï¼Œè·³è¿‡ push æ£€æŸ¥ï¼ˆç”¨äºå¼ºåˆ¶æ„å»ºï¼Œä¸ç­‰å¾…æ‰¹å‡†ï¼‰
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "=========================================="
            echo "å¼ºåˆ¶æ„å»ºè§¦å‘"
            echo "=========================================="
            echo "âœ… å¼ºåˆ¶æ„å»ºå·²å¯ç”¨ï¼Œè·³è¿‡ push æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ£€æŸ¥æ—¶é—´èŒƒå›´
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "=========================================="
            echo "éå®šæ—¶ä»»åŠ¡è§¦å‘"
            echo "=========================================="
            echo "âš ï¸ åªæœ‰å®šæ—¶ä»»åŠ¡ï¼ˆ19:30 åŒ—äº¬æ—¶é—´ï¼‰æ‰ä¼šè‡ªåŠ¨æ£€æŸ¥ push"
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # è®¡ç®—æ£€æŸ¥æ—¶é—´èŒƒå›´ï¼ˆåŒ—äº¬æ—¶é—´ä»Šå¤© 00:00 åˆ° 19:30ï¼‰
          # åŒ—äº¬æ—¶é—´ 00:00 = UTC å‰ä¸€å¤© 16:00
          # åŒ—äº¬æ—¶é—´ 19:30 = UTC å½“å¤© 11:30

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„å¼€å§‹æ—¶é—´ï¼ˆUTC å‰ä¸€å¤© 16:00ï¼‰
          BJ_TODAY_START_UTC=$(date -u -d "yesterday 16:00" +%Y-%m-%dT%H:%M:%SZ)

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„ç»“æŸæ—¶é—´ï¼ˆUTC å½“å¤© 11:30ï¼‰
          # å°†åŒ—äº¬æ—¶é—´ 19:30 è½¬æ¢ä¸º UTC æ—¶é—´ï¼ˆå‡å» 8 å°æ—¶ï¼‰
          CHECK_HOUR_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f1)
          CHECK_MINUTE_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f2)

          # è®¡ç®— UTC æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ - 8å°æ—¶ï¼‰
          if [ $CHECK_HOUR_BJ -ge 8 ]; then
            # å¦‚æœåŒ—äº¬æ—¶é—´ >= 08:00ï¼ŒUTC æ—¶é—´æ˜¯åŒä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ - 8))
            CHECK_DATE_UTC="$CURRENT_DATE_UTC"
          else
            # å¦‚æœåŒ—äº¬æ—¶é—´ < 08:00ï¼ŒUTC æ—¶é—´æ˜¯å‰ä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ + 16))
            CHECK_DATE_UTC=$(date -u -d "yesterday" +%Y-%m-%d)
          fi

          # æ ¼å¼åŒ– UTC æ—¶é—´
          CHECK_TIME_UTC=$(printf "%02d:%02d" $CHECK_HOUR_UTC $CHECK_MINUTE_BJ)
          BJ_TODAY_END_UTC="${CHECK_DATE_UTC}T${CHECK_TIME_UTC}:00Z"

          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (UTC): $BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC"
          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (åŒ—äº¬æ—¶é—´): ä»Šå¤© 00:00 åˆ° $CHECK_TIME_BJ"
          echo ""

          # æ˜¾ç¤ºæ‰€æœ‰ä»Šå¤©çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ä»Šå¤©æ‰€æœ‰çš„ commit (UTC æ—¶é—´):"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ˜¾ç¤ºæœ€è¿‘ 10 ä¸ª commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æœ€è¿‘ 10 ä¸ª commit:"
          git log -10 --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ£€æŸ¥æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ˜¯å¦æœ‰ commit
          COMMITS=$(git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline | wc -l)

          # æ˜¾ç¤ºè¯¥æ—¶é—´èŒƒå›´å†…çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æ—¶é—´èŒƒå›´å†… ($BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC) çš„ commit:"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          echo "=========================================="
          echo "æ£€æŸ¥ç»“æœ"
          echo "=========================================="
          echo "Commit æ•°é‡: $COMMITS"
          echo ""

          # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ„å»º
          if [ "$COMMITS" -gt 0 ]; then
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç° $COMMITS ä¸ª commitï¼Œå°†æ‰§è¡Œæ„å»º"
          else
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "âŒ æ²¡æœ‰å‘ç° commitï¼Œè·³è¿‡æ„å»º"
          fi
          echo "=========================================="

      - name: å‘é€æ£€æŸ¥å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          FAIL_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE="âŒ DeepSeek Chat Agent - æ£€æŸ¥ Push å¤±è´¥ï¼\n\nå¤±è´¥ä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: ${FAIL_TIME}\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${RUN_URL}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

  send-no-push-email:
    name: "å‘é€æ—  Push é€šçŸ¥åˆ° Lark"
    runs-on: ubuntu-latest
    needs: check-push
    if: needs.check-push.outputs.has_push == 'false'
    steps:
      - name: å‘é€ Lark é€šçŸ¥
        run: |
          CURRENT_DATE=$(date +'%Y-%m-%d')
          CURRENT_TIME=$(date +'%H:%M:%S')
          MESSAGE="ğŸ“­ DeepSeek Chat Agent - ä»Šæ—¥æ— éœ€æ„å»º\n\nç”±äºä»Šå¤© 19:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹å‰æ²¡æœ‰ä»£ç  push åˆ°ä»“åº“ï¼Œä»Šå¤©ä¸éœ€è¦æ„å»ºä»£ç ã€‚\n\næ—¥æœŸ: ${CURRENT_DATE}\næ—¶é—´: ${CURRENT_TIME}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

  build:
    name: "æ„å»º Docker é•œåƒ"
    runs-on: ubuntu-latest
    needs: check-push
    if: |
      needs.check-push.outputs.has_push == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.approve_deployment == 'true')
    outputs:
      build_run_id: ${{ github.run_id }}
      build_sha: ${{ github.sha }}
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_artifact_registry: ${{ steps.build.outputs.image_artifact_registry }}
    # æ³¨æ„ï¼šjob outputs å¿…é¡»å¼•ç”¨æ­¥éª¤çš„ outputsï¼Œæ­¥éª¤ outputs é€šè¿‡ GITHUB_OUTPUT è®¾ç½®
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          # é…ç½® Google Artifact Registry
          ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
          if [ -z "$ARTIFACT_REGISTRY_URL" ] || [ "$ARTIFACT_REGISTRY_URL" == "null" ] || [ "$ARTIFACT_REGISTRY_URL" == "" ]; then
            echo "âŒ é”™è¯¯: ARTIFACT_REGISTRY_URL æœªé…ç½®ï¼Œè¯·è®¾ç½® GitHub Secret ARTIFACTORY_URL"
            exit 1
          fi

          if [[ ! "$ARTIFACT_REGISTRY_URL" == *".pkg.dev"* ]]; then
            echo "âŒ é”™è¯¯: ARTIFACT_REGISTRY_URL æ ¼å¼æ— æ•ˆ"
            echo "   æœŸæœ›æ ¼å¼: REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY_NAME"
            echo "   å½“å‰å€¼: $ARTIFACT_REGISTRY_URL"
            exit 1
          fi

          # ä» URL ä¸­æå–åŒºåŸŸï¼ˆä¾‹å¦‚ï¼šus-central1-docker.pkg.dev/firbase-app1-17308/smartageintel -> us-central1ï¼‰
          # æå–ç¬¬ä¸€ä¸ªæ–œæ ä¹‹å‰çš„éƒ¨åˆ†ï¼Œç„¶åæå– -docker.pkg.dev ä¹‹å‰çš„éƒ¨åˆ†
          REGION_HOST=$(echo "$ARTIFACT_REGISTRY_URL" | cut -d'/' -f1)
          REGION=$(echo "$REGION_HOST" | sed 's/-docker\.pkg\.dev$//')
          echo "é…ç½® Artifact Registry Docker è®¤è¯: ${REGION}-docker.pkg.dev"
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
          echo "âœ… Artifact Registry Docker è®¤è¯é…ç½®å®Œæˆ"

      - name: æ„å»º Docker é•œåƒ
        id: build
        run: |
          IMAGE_TAG="${{ github.sha }}"
          ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
          SERVICE_NAME="${{ env.SERVICE_NAME }}"

          echo "=========================================="
          echo "éªŒè¯ Artifact Registry é…ç½®"
          echo "=========================================="
          echo "ARTIFACT_REGISTRY_URL (åŸå§‹å€¼): [$ARTIFACT_REGISTRY_URL]"
          echo "SERVICE_NAME: $SERVICE_NAME"
          echo "IMAGE_TAG: $IMAGE_TAG"
          echo ""

          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
          echo "ARTIFACT_REGISTRY_URL=$ARTIFACT_REGISTRY_URL" >> $GITHUB_ENV
          echo "SERVICE_NAME=$SERVICE_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          # éªŒè¯ Artifact Registry URL æ˜¯å¦é…ç½®
          if [ -z "$ARTIFACT_REGISTRY_URL" ] || [ "$ARTIFACT_REGISTRY_URL" == "null" ] || [ "$ARTIFACT_REGISTRY_URL" == "" ]; then
            echo "âŒ é”™è¯¯: ARTIFACT_REGISTRY_URL æœªé…ç½®ï¼Œè¯·è®¾ç½® GitHub Secret ARTIFACTORY_URL"
            echo "   å½“å‰å€¼: [$ARTIFACT_REGISTRY_URL]"
            exit 1
          fi

          # éªŒè¯ URL æ ¼å¼ï¼ˆåº”è¯¥åŒ…å« .pkg.devï¼‰
          if [[ ! "$ARTIFACT_REGISTRY_URL" == *".pkg.dev"* ]]; then
            echo "âŒ é”™è¯¯: ARTIFACT_REGISTRY_URL æ ¼å¼æ— æ•ˆ"
            echo "   æœŸæœ›æ ¼å¼: REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY_NAME"
            echo "   å½“å‰å€¼: [$ARTIFACT_REGISTRY_URL]"
            exit 1
          fi

          # éªŒè¯ URL ä¸åŒ…å«å°¾éƒ¨æ–œæ 
          ARTIFACT_REGISTRY_URL=$(echo "$ARTIFACT_REGISTRY_URL" | sed 's|/$||')
          echo "ARTIFACT_REGISTRY_URL (å¤„ç†å): [$ARTIFACT_REGISTRY_URL]"
          echo ""

          # æ„å»º Artifact Registry é•œåƒæ ‡ç­¾
          IMAGE_AR="$ARTIFACT_REGISTRY_URL/${{ env.SERVICE_NAME }}:$IMAGE_TAG"
          IMAGE_AR_LATEST="$ARTIFACT_REGISTRY_URL/${{ env.SERVICE_NAME }}:latest"

          # éªŒè¯é•œåƒåœ°å€æ˜¯å¦æ­£ç¡®æ„å»º
          if [ -z "$IMAGE_AR" ] || [ "$IMAGE_AR" == "" ]; then
            echo "âŒ é”™è¯¯: é•œåƒåœ°å€æ„å»ºå¤±è´¥"
            echo "ARTIFACT_REGISTRY_URL: $ARTIFACT_REGISTRY_URL"
            echo "SERVICE_NAME: ${{ env.SERVICE_NAME }}"
            echo "IMAGE_TAG: $IMAGE_TAG"
            exit 1
          fi

          # æ„å»º Docker æ ‡ç­¾åˆ—è¡¨ï¼ˆä½¿ç”¨ Artifact Registryï¼‰
          DOCKER_TAGS="-t $IMAGE_AR -t $IMAGE_AR_LATEST"

          echo "=========================================="
          echo "æ„å»º Docker é•œåƒ"
          echo "=========================================="
          echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "Artifact Registry URL: $ARTIFACT_REGISTRY_URL"
          echo "Artifact Registry é•œåƒ: $IMAGE_AR"
          echo "Artifact Registry é•œåƒ (latest): $IMAGE_AR_LATEST"
          echo ""
          echo "Docker æ ‡ç­¾: $DOCKER_TAGS"
          echo ""

          # æ„å»ºé•œåƒ
          docker build $DOCKER_TAGS .

          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          BUILD_EXIT_CODE=$?
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Docker é•œåƒæ„å»ºå¤±è´¥ï¼Œé€€å‡ºç : $BUILD_EXIT_CODE"
            exit 1
          fi

          # å†æ¬¡éªŒè¯é•œåƒåœ°å€ï¼ˆæ„å»ºåï¼‰
          if [ -z "$IMAGE_AR" ] || [ "$IMAGE_AR" == "" ]; then
            echo "âŒ é”™è¯¯: æ„å»ºåé•œåƒåœ°å€ä¸ºç©º"
            echo "è°ƒè¯•ä¿¡æ¯:"
            echo "  ARTIFACT_REGISTRY_URL: $ARTIFACT_REGISTRY_URL"
            echo "  SERVICE_NAME: ${{ env.SERVICE_NAME }}"
            echo "  IMAGE_TAG: $IMAGE_TAG"
            exit 1
          fi

          echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"
          echo ""
          echo "=========================================="
          echo "å‡†å¤‡è®¾ç½®è¾“å‡ºå˜é‡"
          echo "=========================================="
          echo "image_tag: $IMAGE_TAG"
          echo "image_artifact_registry: $IMAGE_AR"
          echo "IMAGE_AR é•¿åº¦: ${#IMAGE_AR}"
          echo "ARTIFACT_REGISTRY_URL: $ARTIFACT_REGISTRY_URL"
          echo "SERVICE_NAME: $SERVICE_NAME"
          echo ""

          # é‡æ–°æ„å»ºé•œåƒåœ°å€ä»¥ç¡®ä¿æ­£ç¡®æ€§ï¼ˆä½¿ç”¨å½“å‰å˜é‡å€¼ï¼‰
          # å¦‚æœå˜é‡ä¸ºç©ºï¼Œå°è¯•ä»ç¯å¢ƒå˜é‡è·å–
          if [ -z "$ARTIFACT_REGISTRY_URL" ] || [ "$ARTIFACT_REGISTRY_URL" == "" ]; then
            echo "âš ï¸ è­¦å‘Š: ARTIFACT_REGISTRY_URL å˜é‡ä¸ºç©ºï¼Œå°è¯•ä»ç¯å¢ƒå˜é‡è·å–"
            ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
          fi
          if [ -z "$SERVICE_NAME" ] || [ "$SERVICE_NAME" == "" ]; then
            echo "âš ï¸ è­¦å‘Š: SERVICE_NAME å˜é‡ä¸ºç©ºï¼Œå°è¯•ä»ç¯å¢ƒå˜é‡è·å–"
            SERVICE_NAME="${{ env.SERVICE_NAME }}"
          fi

          # æ„å»ºæœ€ç»ˆé•œåƒåœ°å€
          FINAL_IMAGE_AR="$ARTIFACT_REGISTRY_URL/$SERVICE_NAME:$IMAGE_TAG"

          # éªŒè¯æœ€ç»ˆé•œåƒåœ°å€
          if [ -z "$FINAL_IMAGE_AR" ] || [ "$FINAL_IMAGE_AR" == "" ]; then
            echo "âŒ é”™è¯¯: æœ€ç»ˆé•œåƒåœ°å€ä¸ºç©º"
            echo "ARTIFACT_REGISTRY_URL: [$ARTIFACT_REGISTRY_URL]"
            echo "SERVICE_NAME: [$SERVICE_NAME]"
            echo "IMAGE_TAG: [$IMAGE_TAG]"
            echo "ä» env è·å– ARTIFACT_REGISTRY_URL: [${{ env.ARTIFACT_REGISTRY_URL }}]"
            echo "ä» env è·å– SERVICE_NAME: [${{ env.SERVICE_NAME }}]"
            exit 1
          fi

          echo "æœ€ç»ˆé•œåƒåœ°å€: $FINAL_IMAGE_AR"
          echo ""

          # è®¾ç½®è¾“å‡ºå˜é‡
          # æ³¨æ„ï¼šGitHub Actions çš„ outputs å¯¹ç‰¹æ®Šå­—ç¬¦çš„å¤„ç†å¯èƒ½æœ‰é—®é¢˜
          # ä½¿ç”¨å•è¡Œæ ¼å¼ï¼Œä½†ç¡®ä¿å€¼è¢«æ­£ç¡®å¼•ç”¨
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          # å¯¹äºåŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å€¼ï¼Œä½¿ç”¨å•è¡Œæ ¼å¼ä½†ç¡®ä¿å€¼æ­£ç¡®è½¬ä¹‰
          # å¦‚æœå€¼åŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦ç”¨å¼•å·åŒ…è£¹
          echo "image_artifact_registry=$FINAL_IMAGE_AR" >> $GITHUB_OUTPUT

          # éªŒè¯è¾“å‡ºæ˜¯å¦æ­£ç¡®å†™å…¥
          echo "æ£€æŸ¥ GITHUB_OUTPUT ä¸­çš„ image_artifact_registry:"
          grep "image_artifact_registry" $GITHUB_OUTPUT || echo "æœªæ‰¾åˆ° image_artifact_registry"

          echo "âœ… è¾“å‡ºå˜é‡å·²è®¾ç½®"
          echo ""
          echo "éªŒè¯è¾“å‡ºå˜é‡:"
          echo "  image_tag: $IMAGE_TAG"
          echo "  image_artifact_registry: $FINAL_IMAGE_AR"
          echo ""

          # éªŒè¯ GITHUB_OUTPUT æ–‡ä»¶å†…å®¹
          if [ -f "$GITHUB_OUTPUT" ]; then
            echo "GITHUB_OUTPUT æ–‡ä»¶å†…å®¹ï¼ˆæœ€å 3 è¡Œï¼‰:"
            tail -3 "$GITHUB_OUTPUT" || echo "æ— æ³•è¯»å–"
          else
            echo "âš ï¸ è­¦å‘Š: GITHUB_OUTPUT æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          echo "=========================================="

      - name: æ¨é€é•œåƒåˆ° Google Artifact Registry
        run: |
          echo "=========================================="
          echo "æ¨é€é•œåƒåˆ° Google Artifact Registry"
          echo "=========================================="
          echo "é•œåƒæ ‡ç­¾: ${{ steps.build.outputs.image_tag }}"
          echo "é•œåƒåœ°å€: ${{ steps.build.outputs.image_artifact_registry }}"
          echo ""

          # æ¨é€å¸¦æ ‡ç­¾çš„é•œåƒ
          docker push ${{ steps.build.outputs.image_artifact_registry }}
          docker push ${{ env.ARTIFACT_REGISTRY_URL }}/${{ env.SERVICE_NAME }}:latest

          echo ""
          echo "âœ… é•œåƒå·²æ¨é€åˆ° Google Artifact Registry"
          echo "é•œåƒåœ°å€: ${{ steps.build.outputs.image_artifact_registry }}"

      - name: éªŒè¯ Job è¾“å‡ºï¼ˆè°ƒè¯•ï¼‰
        run: |
          echo "=========================================="
          echo "éªŒè¯æ­¥éª¤è¾“å‡ºå˜é‡ï¼ˆç”¨äº Job outputsï¼‰"
          echo "=========================================="
          echo "æ­¥éª¤ build çš„è¾“å‡º:"
          echo "  image_tag: ${{ steps.build.outputs.image_tag }}"
          echo "  image_artifact_registry: ${{ steps.build.outputs.image_artifact_registry }}"
          echo ""
          echo "æ³¨æ„ï¼šè¿™äº›è¾“å‡ºå°†ç”¨äº Job çš„ outputs å®šä¹‰ï¼Œ"
          echo "ç„¶åå¯ä»¥é€šè¿‡ needs.build.outputs åœ¨å…¶ä»– job ä¸­è®¿é—®"
          echo "=========================================="

      - name: å‘é€æ„å»ºæˆåŠŸç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        if: success()
        run: |
          BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          IMAGE_TAG="${{ steps.build.outputs.image_tag }}"
          IMAGE_URL="${{ steps.build.outputs.image_artifact_registry }}"
          MESSAGE="âœ… DeepSeek Chat Agent - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ„å»ºæ—¶é—´: ${BUILD_TIME}\n- é•œåƒæ ‡ç­¾: ${IMAGE_TAG}\n- Artifact Registry é•œåƒ: ${IMAGE_URL}\n\nğŸ“‹ è¯·å‰å¾€ GitHub Actions æ‰¹å‡†éƒ¨ç½²ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\n1. å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢ï¼š${RUN_URL}\n2. æ‰¾åˆ° 'éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰' job\n3. ç‚¹å‡» 'Review deployments' æŒ‰é’®\n4. ç‚¹å‡» 'Approve and deploy' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\n\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\n\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

      - name: å‘é€æ„å»ºå¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          FAIL_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE="âŒ DeepSeek Chat Agent - æ„å»ºå¤±è´¥ï¼\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: ${FAIL_TIME}\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${RUN_URL}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

  notify-pending-approval:
    name: "é€šçŸ¥ç­‰å¾…éƒ¨ç½²æ‰¹å‡†"
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    steps:
      - name: å‘é€ç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        run: |
          BUILD_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          MESSAGE="â³ DeepSeek Chat Agent - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ„å»ºæ—¶é—´: ${BUILD_TIME}\n- é•œåƒæ ‡ç­¾: ${IMAGE_TAG}\n\nğŸ“‹ æ‰¹å‡†éƒ¨ç½²æ­¥éª¤ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\n\n1ï¸âƒ£ å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢\n   ${RUN_URL}\n\n2ï¸âƒ£ æ‰¾åˆ° 'éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰' job\n\n3ï¸âƒ£ ç‚¹å‡» 'Review deployments' æŒ‰é’®\n\n4ï¸âƒ£ ç‚¹å‡» 'Approve and deploy' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\n\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\n\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

  deploy-to-cloud-run:
    name: "éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰"
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'success'
    environment:
      name: cloud-run-production
      url: https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}?project=${{ env.PROJECT_ID }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: æ˜¾ç¤ºæ‰¹å‡†ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²æ‰¹å‡†ä¿¡æ¯"
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å·²é€šè¿‡ GitHub Environment å®¡æ‰¹"
          echo "å®¡æ‰¹äºº: ${{ github.actor }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "é•œåƒ: ${{ needs.build.outputs.image_artifact_registry }}"
          echo "=========================================="

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: éƒ¨ç½²åˆ° Google Cloud Run
        id: deploy
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²åˆ° Google Cloud Run"
          echo "=========================================="
          echo "æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}"
          echo "åŒºåŸŸ: ${{ env.REGION }}"

          # è·å–é•œåƒåœ°å€ï¼ˆä¼˜å…ˆä» job outputs è·å–ï¼‰
          IMAGE_URL="${{ needs.build.outputs.image_artifact_registry }}"
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"

          # å¦‚æœé•œåƒåœ°å€ä¸ºç©ºï¼Œå°è¯•é‡æ–°æ„å»ºï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
          if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" == "" ]; then
            echo "âš ï¸ è­¦å‘Š: ä» job outputs è·å–çš„é•œåƒåœ°å€ä¸ºç©ºï¼Œå°è¯•é‡æ–°æ„å»º"
            echo "æ„å»ºè¾“å‡º:"
            echo "  image_tag: $IMAGE_TAG"
            echo "  image_artifact_registry: $IMAGE_URL"
            echo ""
            
            # é‡æ–°æ„å»ºé•œåƒåœ°å€
            ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
            SERVICE_NAME="${{ env.SERVICE_NAME }}"
            
            if [ -z "$IMAGE_TAG" ] || [ "$IMAGE_TAG" == "" ]; then
              echo "âŒ é”™è¯¯: image_tag ä¹Ÿä¸ºç©ºï¼Œæ— æ³•é‡æ–°æ„å»ºé•œåƒåœ°å€"
              exit 1
            fi
            
            if [ -z "$ARTIFACT_REGISTRY_URL" ] || [ "$ARTIFACT_REGISTRY_URL" == "" ]; then
              echo "âŒ é”™è¯¯: ARTIFACT_REGISTRY_URL ç¯å¢ƒå˜é‡ä¸ºç©ºï¼Œæ— æ³•é‡æ–°æ„å»ºé•œåƒåœ°å€"
              exit 1
            fi
            
            # æ¸…ç†å°¾éƒ¨æ–œæ 
            ARTIFACT_REGISTRY_URL=$(echo "$ARTIFACT_REGISTRY_URL" | sed 's|/$||')
            
            # é‡æ–°æ„å»ºé•œåƒåœ°å€
            IMAGE_URL="$ARTIFACT_REGISTRY_URL/$SERVICE_NAME:$IMAGE_TAG"
            echo "âœ… å·²é‡æ–°æ„å»ºé•œåƒåœ°å€: $IMAGE_URL"
          fi

          # æœ€ç»ˆéªŒè¯é•œåƒåœ°å€
          if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" == "" ]; then
            echo "âŒ é”™è¯¯: é•œåƒåœ°å€ä¸ºç©ºï¼Œæ— æ³•éƒ¨ç½²"
            echo "æœ€ç»ˆé•œåƒåœ°å€: [$IMAGE_URL]"
            exit 1
          fi

          echo "é•œåƒ: $IMAGE_URL"
          echo ""

          # éƒ¨ç½²åˆ° Cloud Run
          # æ³¨æ„ï¼šGradio åº”ç”¨éœ€è¦æ›´å¤šå†…å­˜å’Œ CPU èµ„æº
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image "$IMAGE_URL" \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }},DEEPSEEK_API_BASE=${{ env.DEEPSEEK_API_BASE }} \
            --memory 1Gi \
            --cpu 2 \
            --timeout 300 \
            --max-instances 10 \
            --min-instances 0 \
            --quiet

          echo "âœ… éƒ¨ç½²å®Œæˆ"

      - name: è·å–æœåŠ¡ URL
        id: service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "=========================================="
          echo "æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          echo "=========================================="
          echo "æœåŠ¡ URL: $SERVICE_URL"
          echo "Gradio UI: $SERVICE_URL"
          echo "=========================================="

      - name: å‘é€æœ€ç»ˆéƒ¨ç½²æˆåŠŸé€šçŸ¥åˆ° Lark
        if: success()
        run: |
          DEPLOY_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          IMAGE_TAG="${{ needs.build.outputs.image_tag }}"
          IMAGE_URL="${{ needs.build.outputs.image_artifact_registry }}"
          SERVICE_URL="${{ steps.service_url.outputs.service_url }}"
          CONSOLE_URL="https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}?project=${{ env.PROJECT_ID }}"
          MESSAGE="âœ… DeepSeek Chat Agent - æ„å»ºå’Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ‰¹å‡†äºº: ${{ github.actor }}\n- éƒ¨ç½²æ—¶é—´: ${DEPLOY_TIME}\n- é•œåƒæ ‡ç­¾: ${IMAGE_TAG}\n\næœåŠ¡ä¿¡æ¯ï¼š\n- æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}\n- åŒºåŸŸ: ${{ env.REGION }}\n- Gradio UI: ${SERVICE_URL}\n\né•œåƒä¿¡æ¯ï¼š\n- Artifact Registry é•œåƒ: ${IMAGE_URL}\n\næŸ¥çœ‹æœåŠ¡ï¼š\n${CONSOLE_URL}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"

      - name: å‘é€éƒ¨ç½²å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          FAIL_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          IMAGE_URL="${{ needs.build.outputs.image_artifact_registry }}"
          MESSAGE="âŒ DeepSeek Chat Agent - éƒ¨ç½²å¤±è´¥ï¼\n\néƒ¨ç½²ä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: ${FAIL_TIME}\n- é•œåƒ: ${IMAGE_URL}\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${RUN_URL}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
          JSON_DATA=$(jq -n --arg msg "$MESSAGE" '{"msg_type": "text", "content": {"text": $msg}}')
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA"
