name: "DeepSeek Chat Agent - Build & Deploy to Google Cloud Run"

# å·¥ä½œæµå˜é‡é…ç½®
env:
  # Lark é€šçŸ¥é…ç½®å˜é‡
  LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }} # Lark Webhook URLï¼ˆéœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®ï¼‰

  # Google Cloud é…ç½®å˜é‡
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE_NAME: deepseek-chat-agent
  REGION: asia-east1

  # Google Artifact Registry é…ç½®å˜é‡
  ARTIFACT_REGISTRY_URL: ${{ secrets.ARTIFACTORY_URL }} # Google Artifact Registry URLï¼Œä¾‹å¦‚: asia-east1-docker.pkg.dev/project-id/repository-name

  # æ„å»ºé…ç½®å˜é‡
  CHECK_TIME_BJ: "19:30" # æ£€æŸ¥ push çš„æ—¶é—´ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 19:30ï¼‰

  # DeepSeek API é…ç½®å˜é‡
  DEEPSEEK_API_BASE: ${{ secrets.DEEPSEEK_API_BASE || 'https://api.deepseek.com/v1' }} # DeepSeek API Base URLï¼ˆå¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨å®˜æ–¹ APIï¼‰

on:
  schedule:
    # æ¯å¤© UTC 11:30 æ‰§è¡Œï¼ˆå¯¹åº”åŒ—äº¬æ—¶é—´ 19:30ï¼‰
    # åŒ—äº¬æ—¶é—´ = UTC + 8å°æ—¶ï¼Œæ‰€ä»¥ 19:30 BJ = 11:30 UTC
    - cron: "30 11 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ push æ£€æŸ¥ï¼‰"
        required: false
        default: false
        type: boolean
      approve_deployment:
        description: "æ‰¹å‡†éƒ¨ç½²åˆ° Cloud Runï¼ˆä»…åœ¨æ„å»ºå®Œæˆåä½¿ç”¨ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: read
  checks: read
  id-token: write

jobs:
  check-push:
    name: "æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç  Push"
    runs-on: ubuntu-latest
    outputs:
      has_push: ${{ steps.check.outputs.has_push }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•

      - name: æ£€æŸ¥ä»Šå¤© 00:00-19:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹é—´æ˜¯å¦æœ‰ Push
        id: check
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTCï¼‰
          CURRENT_DATE_UTC=$(date -u +%Y-%m-%d)
          CURRENT_TIME_UTC=$(date -u +%H:%M)
          CHECK_TIME_BJ="${{ env.CHECK_TIME_BJ }}"  # åŒ—äº¬æ—¶é—´ 19:30

          # è®¡ç®—åŒ—äº¬æ—¶é—´çš„å½“å‰æ—¥æœŸå’Œæ—¶é—´
          CURRENT_DATE_BJ=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          CURRENT_TIME_BJ=$(TZ='Asia/Shanghai' date +%H:%M)

          echo "=========================================="
          echo "Push æ£€æŸ¥ä¿¡æ¯"
          echo "=========================================="
          echo "å½“å‰ UTC æ—¶é—´: $CURRENT_DATE_UTC $CURRENT_TIME_UTC"
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $CURRENT_DATE_BJ $CURRENT_TIME_BJ"
          echo "æ£€æŸ¥æ—¶é—´ç‚¹ (åŒ—äº¬æ—¶é—´): $CHECK_TIME_BJ"
          echo "Workflow è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å¼ºåˆ¶æ„å»ºå‚æ•°: ${{ github.event.inputs.force_build }}"
          echo ""

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†æ‰¹å‡†éƒ¨ç½²ï¼Œè·³è¿‡ push æ£€æŸ¥ï¼ˆè¿™æ˜¯ç”¨äºæ‰¹å‡†éƒ¨ç½²çš„ï¼‰
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.approve_deployment }}" == "true" ]; then
            echo "=========================================="
            echo "æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²è§¦å‘"
            echo "=========================================="
            echo "âœ… è¿™æ˜¯æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²çš„è§¦å‘ï¼Œè·³è¿‡ push æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä½†æœªå‹¾é€‰æ‰¹å‡†ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å¼ºåˆ¶æ„å»º
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "=========================================="
            echo "å¼ºåˆ¶æ„å»ºè§¦å‘"
            echo "=========================================="
            echo "âœ… å¼ºåˆ¶æ„å»ºå·²å¯ç”¨ï¼Œè·³è¿‡æ—¶é—´æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ£€æŸ¥æ—¶é—´èŒƒå›´
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "=========================================="
            echo "éå®šæ—¶ä»»åŠ¡è§¦å‘"
            echo "=========================================="
            echo "âš ï¸ åªæœ‰å®šæ—¶ä»»åŠ¡ï¼ˆ19:30 åŒ—äº¬æ—¶é—´ï¼‰æ‰ä¼šè‡ªåŠ¨æ£€æŸ¥ push"
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # è®¡ç®—æ£€æŸ¥æ—¶é—´èŒƒå›´ï¼ˆåŒ—äº¬æ—¶é—´ä»Šå¤© 00:00 åˆ° 19:30ï¼‰
          # åŒ—äº¬æ—¶é—´ 00:00 = UTC å‰ä¸€å¤© 16:00
          # åŒ—äº¬æ—¶é—´ 19:30 = UTC å½“å¤© 11:30

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„å¼€å§‹æ—¶é—´ï¼ˆUTC å‰ä¸€å¤© 16:00ï¼‰
          BJ_TODAY_START_UTC=$(date -u -d "yesterday 16:00" +%Y-%m-%dT%H:%M:%SZ)

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„ç»“æŸæ—¶é—´ï¼ˆUTC å½“å¤© 11:30ï¼‰
          # å°†åŒ—äº¬æ—¶é—´ 19:30 è½¬æ¢ä¸º UTC æ—¶é—´ï¼ˆå‡å» 8 å°æ—¶ï¼‰
          CHECK_HOUR_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f1)
          CHECK_MINUTE_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f2)

          # è®¡ç®— UTC æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ - 8å°æ—¶ï¼‰
          if [ $CHECK_HOUR_BJ -ge 8 ]; then
            # å¦‚æœåŒ—äº¬æ—¶é—´ >= 08:00ï¼ŒUTC æ—¶é—´æ˜¯åŒä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ - 8))
            CHECK_DATE_UTC="$CURRENT_DATE_UTC"
          else
            # å¦‚æœåŒ—äº¬æ—¶é—´ < 08:00ï¼ŒUTC æ—¶é—´æ˜¯å‰ä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ + 16))
            CHECK_DATE_UTC=$(date -u -d "yesterday" +%Y-%m-%d)
          fi

          # æ ¼å¼åŒ– UTC æ—¶é—´
          CHECK_TIME_UTC=$(printf "%02d:%02d" $CHECK_HOUR_UTC $CHECK_MINUTE_BJ)
          BJ_TODAY_END_UTC="${CHECK_DATE_UTC}T${CHECK_TIME_UTC}:00Z"

          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (UTC): $BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC"
          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (åŒ—äº¬æ—¶é—´): ä»Šå¤© 00:00 åˆ° $CHECK_TIME_BJ"
          echo ""

          # æ˜¾ç¤ºæ‰€æœ‰ä»Šå¤©çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ä»Šå¤©æ‰€æœ‰çš„ commit (UTC æ—¶é—´):"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ˜¾ç¤ºæœ€è¿‘ 10 ä¸ª commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æœ€è¿‘ 10 ä¸ª commit:"
          git log -10 --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ£€æŸ¥æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ˜¯å¦æœ‰ commit
          COMMITS=$(git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline | wc -l)

          # æ˜¾ç¤ºè¯¥æ—¶é—´èŒƒå›´å†…çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æ—¶é—´èŒƒå›´å†… ($BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC) çš„ commit:"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          echo "=========================================="
          echo "æ£€æŸ¥ç»“æœ"
          echo "=========================================="
          echo "Commit æ•°é‡: $COMMITS"
          echo ""

          # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ„å»º
          if [ "$COMMITS" -gt 0 ]; then
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç° $COMMITS ä¸ª commitï¼Œå°†æ‰§è¡Œæ„å»º"
          else
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "âŒ æ²¡æœ‰å‘ç° commitï¼Œè·³è¿‡æ„å»º"
          fi
          echo "=========================================="

      - name: å‘é€æ£€æŸ¥å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âŒ DeepSeek Chat Agent - æ£€æŸ¥ Push å¤±è´¥ï¼\n\nå¤±è´¥ä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

  send-no-push-email:
    name: "å‘é€æ—  Push é€šçŸ¥åˆ° Lark"
    runs-on: ubuntu-latest
    needs: check-push
    if: needs.check-push.outputs.has_push == 'false'
    steps:
      - name: å‘é€ Lark é€šçŸ¥
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ“­ DeepSeek Chat Agent - ä»Šæ—¥æ— éœ€æ„å»º\n\nç”±äºä»Šå¤© 19:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹å‰æ²¡æœ‰ä»£ç  push åˆ°ä»“åº“ï¼Œä»Šå¤©ä¸éœ€è¦æ„å»ºä»£ç ã€‚\n\næ—¥æœŸ: $(date +'%Y-%m-%d')\næ—¶é—´: $(date +'%H:%M:%S')\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

  build:
    name: "æ„å»º Docker é•œåƒ"
    runs-on: ubuntu-latest
    needs: check-push
    if: |
      needs.check-push.outputs.has_push == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.approve_deployment == 'true')
    outputs:
      build_run_id: ${{ github.run_id }}
      build_sha: ${{ github.sha }}
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_gcr: ${{ steps.build.outputs.image_gcr }}
      image_artifact_registry: ${{ steps.build.outputs.image_artifact_registry }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR and Artifact Registry
        run: |
          # é…ç½® Google Container Registry
          gcloud auth configure-docker
          # é…ç½® Google Artifact Registryï¼ˆå¦‚æœé…ç½®äº†ï¼‰
          ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
          if [ -n "$ARTIFACT_REGISTRY_URL" ] && [ "$ARTIFACT_REGISTRY_URL" != "null" ] && [[ "$ARTIFACT_REGISTRY_URL" == *".pkg.dev"* ]]; then
            # ä» URL ä¸­æå–åŒºåŸŸï¼ˆä¾‹å¦‚ï¼šasia-east1-docker.pkg.dev -> asia-east1ï¼‰
            REGION=$(echo "$ARTIFACT_REGISTRY_URL" | cut -d'-' -f1)
            echo "é…ç½® Artifact Registry Docker è®¤è¯: ${REGION}-docker.pkg.dev"
            gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
          else
            echo "â„¹ï¸ Artifact Registry æœªé…ç½®æˆ–æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡ Docker è®¤è¯é…ç½®"
          fi

      - name: æ„å»º Docker é•œåƒ
        id: build
        run: |
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_GCR="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:$IMAGE_TAG"

          # æ„å»º Docker æ ‡ç­¾åˆ—è¡¨ï¼ˆå§‹ç»ˆåŒ…å« GCR æ ‡ç­¾ï¼‰
          DOCKER_TAGS="-t $IMAGE_GCR -t gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest"     

          # æ£€æŸ¥ Artifact Registry URL æ˜¯å¦é…ç½®ä¸”æœ‰æ•ˆ
          ARTIFACT_REGISTRY_URL="${{ env.ARTIFACT_REGISTRY_URL }}"
          if [ -n "$ARTIFACT_REGISTRY_URL" ] && [ "$ARTIFACT_REGISTRY_URL" != "null" ] && [ "$ARTIFACT_REGISTRY_URL" != "" ]; then
            # éªŒè¯ URL æ ¼å¼ï¼ˆåº”è¯¥åŒ…å« .pkg.devï¼‰
            if [[ "$ARTIFACT_REGISTRY_URL" == *".pkg.dev"* ]]; then
              IMAGE_AR="$ARTIFACT_REGISTRY_URL/${{ env.SERVICE_NAME }}:$IMAGE_TAG"
              IMAGE_AR_LATEST="$ARTIFACT_REGISTRY_URL/${{ env.SERVICE_NAME }}:latest"
              DOCKER_TAGS="$DOCKER_TAGS -t $IMAGE_AR -t $IMAGE_AR_LATEST"
              echo "image_artifact_registry=$IMAGE_AR" >> $GITHUB_OUTPUT
              echo "âœ… Artifact Registry å·²é…ç½®: $ARTIFACT_REGISTRY_URL"
            else
              echo "âš ï¸ è­¦å‘Š: ARTIFACT_REGISTRY_URL æ ¼å¼æ— æ•ˆï¼Œè·³è¿‡ Artifact Registry æ ‡ç­¾"
              echo "   æœŸæœ›æ ¼å¼: REGION-docker.pkg.dev/PROJECT_ID/REPOSITORY_NAME"
              echo "   å½“å‰å€¼: $ARTIFACT_REGISTRY_URL"
            fi
          else
            echo "â„¹ï¸ Artifact Registry æœªé…ç½®ï¼Œä»…æ¨é€åˆ° GCR"
          fi

          echo "=========================================="
          echo "æ„å»º Docker é•œåƒ"
          echo "=========================================="
          echo "é•œåƒæ ‡ç­¾: $IMAGE_TAG"
          echo "GCR é•œåƒ: $IMAGE_GCR"
          if [ -n "$ARTIFACT_REGISTRY_URL" ] && [ "$ARTIFACT_REGISTRY_URL" != "null" ] && [[ "$ARTIFACT_REGISTRY_URL" == *".pkg.dev"* ]]; then
            echo "Artifact Registry é•œåƒ: $IMAGE_AR"
          fi
          echo ""
          echo "Docker æ ‡ç­¾: $DOCKER_TAGS"
          echo ""

          # æ„å»ºé•œåƒ
          docker build $DOCKER_TAGS .

          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_gcr=$IMAGE_GCR" >> $GITHUB_OUTPUT

          echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"

      - name: æ¨é€é•œåƒåˆ° Google Container Registry
        run: |
          echo "æ¨é€é•œåƒåˆ° GCR..."
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ steps.build.outputs.image_tag }}
          docker push gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest
          echo "âœ… é•œåƒå·²æ¨é€åˆ° GCR"

      - name: æ¨é€é•œåƒåˆ° Google Artifact Registry
        if: env.ARTIFACT_REGISTRY_URL != ''
        run: |
          echo "=========================================="
          echo "æ¨é€é•œåƒåˆ° Google Artifact Registry"
          echo "=========================================="

          # æ¨é€å¸¦æ ‡ç­¾çš„é•œåƒ
          docker push ${{ env.ARTIFACT_REGISTRY_URL }}/${{ env.SERVICE_NAME }}:${{ steps.build.outputs.image_tag }}
          docker push ${{ env.ARTIFACT_REGISTRY_URL }}/${{ env.SERVICE_NAME }}:latest

          echo "âœ… é•œåƒå·²æ¨é€åˆ° Google Artifact Registry"
          echo "é•œåƒåœ°å€: ${{ env.ARTIFACT_REGISTRY_URL }}/${{ env.SERVICE_NAME }}:${{ steps.build.outputs.image_tag }}"

      - name: å‘é€æ„å»ºæˆåŠŸç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        if: success()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âœ… DeepSeek Chat Agent - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n- é•œåƒæ ‡ç­¾: ${{ steps.build.outputs.image_tag }}\n- GCR é•œåƒ: ${{ steps.build.outputs.image_gcr }}\n\nğŸ“‹ è¯·å‰å¾€ GitHub Actions æ‰¹å‡†éƒ¨ç½²ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\n1. å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n2. æ‰¾åˆ° '\''éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰'\'' job\n3. ç‚¹å‡» '\''Review deployments'\'' æŒ‰é’®\n4. ç‚¹å‡» '\''Approve and deploy'\'' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\n\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\n\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

      - name: å‘é€æ„å»ºå¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âŒ DeepSeek Chat Agent - æ„å»ºå¤±è´¥ï¼\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

  notify-pending-approval:
    name: "é€šçŸ¥ç­‰å¾…éƒ¨ç½²æ‰¹å‡†"
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    steps:
      - name: å‘é€ç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "â³ DeepSeek Chat Agent - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n- é•œåƒæ ‡ç­¾: ${{ needs.build.outputs.image_tag }}\n\nğŸ“‹ æ‰¹å‡†éƒ¨ç½²æ­¥éª¤ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\n\n1ï¸âƒ£ å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢\n   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\n2ï¸âƒ£ æ‰¾åˆ° '\''éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰'\'' job\n\n3ï¸âƒ£ ç‚¹å‡» '\''Review deployments'\'' æŒ‰é’®\n\n4ï¸âƒ£ ç‚¹å‡» '\''Approve and deploy'\'' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\n\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\n\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

  deploy-to-cloud-run:
    name: "éƒ¨ç½²åˆ° Google Cloud Runï¼ˆéœ€è¦æ‰¹å‡†ï¼‰"
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'success'
    environment:
      name: cloud-run-production
      url: https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}?project=${{ env.PROJECT_ID }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: æ˜¾ç¤ºæ‰¹å‡†ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²æ‰¹å‡†ä¿¡æ¯"
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å·²é€šè¿‡ GitHub Environment å®¡æ‰¹"
          echo "å®¡æ‰¹äºº: ${{ github.actor }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "é•œåƒ: ${{ needs.build.outputs.image_gcr }}"
          echo "=========================================="

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: éƒ¨ç½²åˆ° Google Cloud Run
        id: deploy
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²åˆ° Google Cloud Run"
          echo "=========================================="
          echo "æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}"
          echo "åŒºåŸŸ: ${{ env.REGION }}"
          echo "é•œåƒ: ${{ needs.build.outputs.image_gcr }}"
          echo ""

          # éƒ¨ç½²åˆ° Cloud Run
          # æ³¨æ„ï¼šGradio åº”ç”¨éœ€è¦æ›´å¤šå†…å­˜å’Œ CPU èµ„æº
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ needs.build.outputs.image_gcr }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --set-env-vars DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }},DEEPSEEK_API_BASE=${{ env.DEEPSEEK_API_BASE }} \
            --memory 1Gi \
            --cpu 2 \
            --timeout 300 \
            --max-instances 10 \
            --min-instances 0 \
            --quiet

          echo "âœ… éƒ¨ç½²å®Œæˆ"

      - name: è·å–æœåŠ¡ URL
        id: service_url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region ${{ env.REGION }} --format 'value(status.url)')
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "=========================================="
          echo "æœåŠ¡éƒ¨ç½²æˆåŠŸ"
          echo "=========================================="
          echo "æœåŠ¡ URL: $SERVICE_URL"
          echo "Gradio UI: $SERVICE_URL"
          echo "=========================================="

      - name: å‘é€æœ€ç»ˆéƒ¨ç½²æˆåŠŸé€šçŸ¥åˆ° Lark
        if: success()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âœ… DeepSeek Chat Agent - æ„å»ºå’Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼\n\næ„å»ºä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- æ‰¹å‡†äºº: ${{ github.actor }}\n- éƒ¨ç½²æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n- é•œåƒæ ‡ç­¾: ${{ needs.build.outputs.image_tag }}\n\næœåŠ¡ä¿¡æ¯ï¼š\n- æœåŠ¡åç§°: ${{ env.SERVICE_NAME }}\n- åŒºåŸŸ: ${{ env.REGION }}\n- Gradio UI: ${{ steps.service_url.outputs.service_url }}\n\né•œåƒä¿¡æ¯ï¼š\n- GCR é•œåƒ: ${{ needs.build.outputs.image_gcr }}\n\næŸ¥çœ‹æœåŠ¡ï¼š\nhttps://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}?project=${{ env.PROJECT_ID }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

      - name: å‘é€éƒ¨ç½²å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âŒ DeepSeek Chat Agent - éƒ¨ç½²å¤±è´¥ï¼\n\néƒ¨ç½²ä¿¡æ¯ï¼š\n- Commit: ${{ github.sha }}\n- åˆ†æ”¯: ${{ github.ref_name }}\n- ä½œè€…: ${{ github.actor }}\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\n- é•œåƒ: ${{ needs.build.outputs.image_gcr }}\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'
