name: "Flutter Build & Deploy to Firebase App Distribution"

# å·¥ä½œæµå˜é‡é…ç½® - å¯ä»¥åœ¨æ–‡ä»¶é¡¶éƒ¨ä¿®æ”¹è¿™äº›å˜é‡
env:
  # Lark é€šçŸ¥é…ç½®å˜é‡
  LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }} # Lark Webhook URLï¼ˆéœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®ï¼‰

  # Firebase é…ç½®å˜é‡
  FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
  FIREBASE_GROUPS: "testers" # Firebase App Distribution æµ‹è¯•ç»„
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }} # Firebase é¡¹ç›® IDï¼ˆç”¨äº Test Labï¼‰

  # Test Lab é…ç½®å˜é‡
  TEST_DEVICE_MODEL: "Pixel3" # æµ‹è¯•è®¾å¤‡å‹å·ï¼ˆå¯ä¿®æ”¹ï¼šPixel2, Pixel3, Pixel4 ç­‰ï¼‰
  TEST_DEVICE_VERSION: "29" # Android ç‰ˆæœ¬ï¼ˆå¯ä¿®æ”¹ï¼š28=Android 9, 29=Android 10 ç­‰ï¼‰
  TEST_LOCALE: "zh_HK" # æµ‹è¯•è¯­è¨€ç¯å¢ƒï¼ˆå¯ä¿®æ”¹ï¼šzh_HK, en_US ç­‰ï¼‰
  TEST_ORIENTATION: "portrait" # å±å¹•æ–¹å‘ï¼športrait æˆ– landscape

  # æ„å»ºé…ç½®å˜é‡
  FLUTTER_VERSION: "3.35.6"
  JAVA_VERSION: "17"
  CHECK_TIME_BJ: "20:30" # æ£€æŸ¥ push çš„æ—¶é—´ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 20:30ï¼‰

on:
  schedule:
    # æ¯å¤© UTC 12:30 æ‰§è¡Œï¼ˆå¯¹åº”é¦™æ¸¯æ—¶é—´ 20:30ï¼‰
    - cron: "30 12 * * *" # UTC æ—¶é—´ 12:30 = é¦™æ¸¯æ—¶é—´ 20:30
  workflow_dispatch:
    inputs:
      force_build:
        description: "å¼ºåˆ¶æ„å»ºï¼ˆè·³è¿‡ push æ£€æŸ¥ï¼‰"
        required: false
        default: false
        type: boolean
      approve_deployment:
        description: "æ‰¹å‡†éƒ¨ç½²åˆ° Firebaseï¼ˆä»…åœ¨æ„å»ºå®Œæˆåä½¿ç”¨ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  check-push:
    name: "æ£€æŸ¥æ˜¯å¦æœ‰ä»£ç  Push"
    runs-on: ubuntu-latest
    outputs:
      has_push: ${{ steps.check.outputs.has_push }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•

      - name: æ£€æŸ¥ä»Šå¤© 00:00-20:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹é—´æ˜¯å¦æœ‰ Push
        id: check
        run: |
          # è·å–å½“å‰æ—¶é—´ï¼ˆUTCï¼‰
          CURRENT_DATE_UTC=$(date -u +%Y-%m-%d)
          CURRENT_TIME_UTC=$(date -u +%H:%M)
          CHECK_TIME_BJ="${{ env.CHECK_TIME_BJ }}"  # åŒ—äº¬æ—¶é—´ 20:30

          # è®¡ç®—åŒ—äº¬æ—¶é—´çš„å½“å‰æ—¥æœŸå’Œæ—¶é—´
          CURRENT_DATE_BJ=$(TZ='Asia/Shanghai' date +%Y-%m-%d)
          CURRENT_TIME_BJ=$(TZ='Asia/Shanghai' date +%H:%M)

          echo "=========================================="
          echo "Push æ£€æŸ¥ä¿¡æ¯"
          echo "=========================================="
          echo "å½“å‰ UTC æ—¶é—´: $CURRENT_DATE_UTC $CURRENT_TIME_UTC"
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $CURRENT_DATE_BJ $CURRENT_TIME_BJ"
          echo "æ£€æŸ¥æ—¶é—´ç‚¹ (åŒ—äº¬æ—¶é—´): $CHECK_TIME_BJ"
          echo "Workflow è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "å¼ºåˆ¶æ„å»ºå‚æ•°: ${{ github.event.inputs.force_build }}"
          echo ""

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†æ‰¹å‡†éƒ¨ç½²ï¼Œè·³è¿‡ push æ£€æŸ¥ï¼ˆè¿™æ˜¯ç”¨äºæ‰¹å‡†éƒ¨ç½²çš„ï¼‰
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.approve_deployment }}" == "true" ]; then
            echo "=========================================="
            echo "æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²è§¦å‘"
            echo "=========================================="
            echo "âœ… è¿™æ˜¯æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²çš„è§¦å‘ï¼Œè·³è¿‡ push æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä½†æœªå‹¾é€‰æ‰¹å‡†ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å¼ºåˆ¶æ„å»º
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_build }}" == "true" ]; then
            echo "=========================================="
            echo "å¼ºåˆ¶æ„å»ºè§¦å‘"
            echo "=========================================="
            echo "âœ… å¼ºåˆ¶æ„å»ºå·²å¯ç”¨ï¼Œè·³è¿‡æ—¶é—´æ£€æŸ¥"
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ£€æŸ¥æ—¶é—´èŒƒå›´
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "=========================================="
            echo "éå®šæ—¶ä»»åŠ¡è§¦å‘"
            echo "=========================================="
            echo "âš ï¸ åªæœ‰å®šæ—¶ä»»åŠ¡ï¼ˆ20:30 HK æ—¶é—´ï¼‰æ‰ä¼šè‡ªåŠ¨æ£€æŸ¥ push"
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "=========================================="
            exit 0
          fi

          # è®¡ç®—æ£€æŸ¥æ—¶é—´èŒƒå›´ï¼ˆåŒ—äº¬æ—¶é—´ä»Šå¤© 00:00 åˆ° 20:30ï¼‰
          # åŒ—äº¬æ—¶é—´ 00:00 = UTC å‰ä¸€å¤© 16:00
          # åŒ—äº¬æ—¶é—´ 20:30 = UTC å½“å¤© 12:30

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„å¼€å§‹æ—¶é—´ï¼ˆUTC å‰ä¸€å¤© 16:00ï¼‰
          BJ_TODAY_START_UTC=$(date -u -d "yesterday 16:00" +%Y-%m-%dT%H:%M:%SZ)

          # è·å–åŒ—äº¬æ—¶é—´ä»Šå¤©çš„ç»“æŸæ—¶é—´ï¼ˆUTC å½“å¤© 12:30ï¼‰
          # å°†åŒ—äº¬æ—¶é—´ 20:30 è½¬æ¢ä¸º UTC æ—¶é—´ï¼ˆå‡å» 8 å°æ—¶ï¼‰
          CHECK_HOUR_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f1)
          CHECK_MINUTE_BJ=$(echo $CHECK_TIME_BJ | cut -d':' -f2)

          # è®¡ç®— UTC æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ - 8å°æ—¶ï¼‰
          if [ $CHECK_HOUR_BJ -ge 8 ]; then
            # å¦‚æœåŒ—äº¬æ—¶é—´ >= 08:00ï¼ŒUTC æ—¶é—´æ˜¯åŒä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ - 8))
            CHECK_DATE_UTC="$CURRENT_DATE_UTC"
          else
            # å¦‚æœåŒ—äº¬æ—¶é—´ < 08:00ï¼ŒUTC æ—¶é—´æ˜¯å‰ä¸€å¤©
            CHECK_HOUR_UTC=$((CHECK_HOUR_BJ + 16))
            CHECK_DATE_UTC=$(date -u -d "yesterday" +%Y-%m-%d)
          fi

          # æ ¼å¼åŒ– UTC æ—¶é—´
          CHECK_TIME_UTC=$(printf "%02d:%02d" $CHECK_HOUR_UTC $CHECK_MINUTE_BJ)
          BJ_TODAY_END_UTC="${CHECK_DATE_UTC}T${CHECK_TIME_UTC}:00Z"

          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (UTC): $BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC"
          echo "æ£€æŸ¥æ—¶é—´èŒƒå›´ (åŒ—äº¬æ—¶é—´): ä»Šå¤© 00:00 åˆ° $CHECK_TIME_BJ"
          echo ""

          # æ˜¾ç¤ºæ‰€æœ‰ä»Šå¤©çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ä»Šå¤©æ‰€æœ‰çš„ commit (UTC æ—¶é—´):"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ˜¾ç¤ºæœ€è¿‘ 10 ä¸ª commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æœ€è¿‘ 10 ä¸ª commit:"
          git log -10 --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          # æ£€æŸ¥æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ˜¯å¦æœ‰ commit
          COMMITS=$(git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline | wc -l)

          # æ˜¾ç¤ºè¯¥æ—¶é—´èŒƒå›´å†…çš„ commitï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "æ—¶é—´èŒƒå›´å†… ($BJ_TODAY_START_UTC åˆ° $BJ_TODAY_END_UTC) çš„ commit:"
          git log --since="$BJ_TODAY_START_UTC" --until="$BJ_TODAY_END_UTC" --oneline --date=iso --format="%h %ad %s" || echo "æ—  commit"
          echo ""

          echo "=========================================="
          echo "æ£€æŸ¥ç»“æœ"
          echo "=========================================="
          echo "Commit æ•°é‡: $COMMITS"
          echo ""

          # åˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ„å»º
          if [ "$COMMITS" -gt 0 ]; then
            echo "has_push=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç° $COMMITS ä¸ª commitï¼Œå°†æ‰§è¡Œæ„å»º"
          else
            echo "has_push=false" >> $GITHUB_OUTPUT
            echo "âŒ æ²¡æœ‰å‘ç° commitï¼Œè·³è¿‡æ„å»º"
          fi
          echo "=========================================="

  send-no-push-email:
    name: "å‘é€æ—  Push é€šçŸ¥åˆ° Lark"
    runs-on: ubuntu-latest
    needs: check-push
    if: needs.check-push.outputs.has_push == 'false'
    steps:
      - name: å‘é€ Lark é€šçŸ¥
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "ğŸ“­ SmartAge App - ä»Šæ—¥æ— éœ€æ„å»º\n\nç”±äºä»Šå¤© 20:30ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ä¹‹å‰æ²¡æœ‰ä»£ç  push åˆ°ä»“åº“ï¼Œä»Šå¤©ä¸éœ€è¦æ„å»ºä»£ç ã€‚\n\næ—¥æœŸ: $(date +'%Y-%m-%d')\næ—¶é—´: $(date +'%H:%M:%S')\n\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚"
              }
            }'

  build:
    name: "æ„å»ºå’Œæµ‹è¯•"
    runs-on: ubuntu-latest
    needs: check-push
    if: |
      needs.check-push.outputs.has_push == 'true' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.approve_deployment == 'true')
    outputs:
      robo_test_status: ${{ steps.robo_test.outputs.robo_test_status }}
      build_run_id: ${{ github.run_id }}
      build_sha: ${{ github.sha }}
      app_version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: æ£€æŸ¥æ„å»ºå®Œæˆæ ‡è®°ï¼ˆæ‰¹å‡†éƒ¨ç½²æ¨¡å¼ï¼‰
        id: check_build_flag
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.approve_deployment == 'true'
        run: |
          # åˆå§‹åŒ–é»˜è®¤å€¼
          echo "build_ready=0" >> $GITHUB_OUTPUT
          echo "artifact_found=false" >> $GITHUB_OUTPUT
          echo "==== æ£€æŸ¥æ„å»ºå®Œæˆæ ‡è®° ===="
          echo "æŸ¥æ‰¾æœ€è¿‘çš„æ„å»ºå®Œæˆæ ‡è®°..."

          # å®‰è£… GitHub CLIï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
          if ! command -v gh &> /dev/null; then
            echo "å®‰è£… GitHub CLI..."
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi

          # è®¾ç½® GitHub token
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

          # æŸ¥æ‰¾æœ€è¿‘çš„æˆåŠŸæ„å»ºè¿è¡Œï¼ˆæ’é™¤å½“å‰è¿è¡Œï¼‰
          echo "æŸ¥æ‰¾æœ€è¿‘çš„æˆåŠŸæ„å»ºè¿è¡Œ..."
          LATEST_RUN=$(gh run list --workflow=flutter_firebase_deploy.yml --status=success --limit=10 --json databaseId,conclusion,createdAt --jq '.[] | select(.databaseId != '${{ github.run_id }}') | .databaseId' | head -n 1)

          if [ -z "$LATEST_RUN" ]; then
            echo "build_ready=0" >> $GITHUB_OUTPUT
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            echo "âŒ æœªæ‰¾åˆ°æœ€è¿‘çš„æ„å»ºè¿è¡Œï¼Œå°†ä»å¤´å¼€å§‹æ„å»º"
            exit 0
          fi

          echo "æ‰¾åˆ°è¿è¡Œ ID: $LATEST_RUN"

          # æ£€æŸ¥è¯¥è¿è¡Œæ˜¯å¦æœ‰ build-ready-flag artifactï¼ˆæ ‡è®°æ„å»ºå·²å®Œæˆï¼‰
          FLAG_EXISTS=$(gh run view $LATEST_RUN --json artifacts --jq '.artifacts[] | select(.name == "build-ready-flag") | .name' || echo "")

          if [ -z "$FLAG_EXISTS" ]; then
            echo "build_ready=0" >> $GITHUB_OUTPUT
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            echo "âŒ è¿è¡Œ $LATEST_RUN æ²¡æœ‰æ„å»ºå®Œæˆæ ‡è®°ï¼Œå°†ä»å¤´å¼€å§‹æ„å»º"
            exit 0
          fi

          echo "âœ… æ‰¾åˆ°æ„å»ºå®Œæˆæ ‡è®°ï¼Œæ„å»ºå·²å®Œæˆ"

          # æ£€æŸ¥è¯¥è¿è¡Œæ˜¯å¦æœ‰ release-apk artifact
          APK_EXISTS=$(gh run view $LATEST_RUN --json artifacts --jq '.artifacts[] | select(.name == "release-apk") | .name' || echo "")

          if [ -z "$APK_EXISTS" ]; then
            echo "build_ready=0" >> $GITHUB_OUTPUT
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            echo "âŒ è¿è¡Œ $LATEST_RUN æ²¡æœ‰ APK artifactï¼Œå°†ä»å¤´å¼€å§‹æ„å»º"
            exit 0
          fi

          # ä¸‹è½½æ„å»ºæ ‡è®°æ–‡ä»¶ï¼ˆæŸ¥çœ‹æ„å»ºä¿¡æ¯ï¼‰
          echo "ä¸‹è½½æ„å»ºæ ‡è®°æ–‡ä»¶..."
          mkdir -p .build-info
          if gh run download $LATEST_RUN -n build-ready-flag -D .build-info 2>/dev/null; then
            echo "æ„å»ºä¿¡æ¯ï¼š"
            cat .build-info/build-ready.flag || true
          fi

          # ä¸‹è½½ APK artifact
          echo "ä¸‹è½½ APK artifact..."
          mkdir -p build/app/outputs/flutter-apk
          if gh run download $LATEST_RUN -n release-apk -D build/app/outputs/flutter-apk; then
            echo "build_ready=1" >> $GITHUB_OUTPUT
            echo "artifact_found=true" >> $GITHUB_OUTPUT
            echo "artifact_run_id=$LATEST_RUN" >> $GITHUB_OUTPUT
            echo "âœ… æ„å»ºå·²å®Œæˆï¼ˆæ ‡è®°=1ï¼‰ï¼ŒæˆåŠŸä¸‹è½½ APKï¼Œå°†è·³è¿‡æ„å»ºæ­¥éª¤"
            
            # åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
            echo "ä¸‹è½½çš„æ–‡ä»¶ï¼š"
            ls -lh build/app/outputs/flutter-apk/ || true
          else
            echo "build_ready=0" >> $GITHUB_OUTPUT
            echo "artifact_found=false" >> $GITHUB_OUTPUT
            echo "âŒ ä¸‹è½½ APK artifact å¤±è´¥ï¼Œå°†ä»å¤´å¼€å§‹æ„å»º"
          fi

      - name: Cache Flutter/Dart pub packages
        if: steps.check_build_flag.outputs.build_ready != '1'
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Setup Java
        if: steps.check_build_flag.outputs.build_ready != '1'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        if: steps.check_build_flag.outputs.build_ready != '1'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        if: steps.check_build_flag.outputs.build_ready != '1'
        run: flutter pub get

      - name: è·å–åº”ç”¨ç‰ˆæœ¬å·
        id: get_version
        run: |
          if [ -f "pubspec.yaml" ]; then
            VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2)
          else
            # å¦‚æœä½¿ç”¨ä¹‹å‰çš„ artifactï¼Œå°è¯•ä» APK æ–‡ä»¶åè·å–ç‰ˆæœ¬ä¿¡æ¯
            VERSION="unknown"
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              echo "ä½¿ç”¨ä¹‹å‰çš„æ„å»ºäº§ç‰©ï¼Œç‰ˆæœ¬ä¿¡æ¯å¯èƒ½ä¸å‡†ç¡®"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "åº”ç”¨ç‰ˆæœ¬: $VERSION"

      - name: Flutter analyze
        if: steps.check_build_flag.outputs.build_ready != '1'
        continue-on-error: true
        run: flutter analyze

      - name: Decode and setup keystore
        if: steps.check_build_flag.outputs.build_ready != '1'
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/smartage-nurseai-app.jks
          echo "${{ secrets.KEY_PROPERTIES }}" > android/key.properties

      - name: Build APK
        if: steps.check_build_flag.outputs.build_ready != '1'
        run: |
          flutter build apk --release

      - name: ç¡®è®¤ APK æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âŒ APK æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… APK æ–‡ä»¶å·²å‡†å¤‡å°±ç»ª"
          ls -lh build/app/outputs/flutter-apk/app-release.apk

      - name: åˆ›å»ºæ„å»ºå®Œæˆæ ‡è®°
        run: |
          echo "æ„å»ºå®Œæˆæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > build-ready.flag
          echo "è¿è¡Œ ID: ${{ github.run_id }}" >> build-ready.flag
          echo "Commit: ${{ github.sha }}" >> build-ready.flag
          echo "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}" >> build-ready.flag
          cat build-ready.flag

      - name: ä¸Šä¼  APK æ–‡ä»¶ï¼ˆä¾›éƒ¨ç½²ä½¿ç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 1

      - name: ä¸Šä¼ æ„å»ºå®Œæˆæ ‡è®°
        uses: actions/upload-artifact@v4
        with:
          name: build-ready-flag
          path: build-ready.flag
          retention-days: 1

      - name: å®‰è£… Google Cloud SDK
        if: steps.check_build_flag.outputs.build_ready != '1'
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
          project_id: ${{ env.FIREBASE_PROJECT_ID }}
          export_default_credentials: true

      - name: è¿è¡Œ Firebase Test Lab - Random Crawl Test
        id: robo_test
        env:
          FIREBASE_SA_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          # åˆå§‹åŒ–é»˜è®¤å€¼ï¼Œç¡®ä¿æ€»æ˜¯æœ‰è¾“å‡º
          echo "robo_test_status=passed" >> $GITHUB_OUTPUT

          if [ "${{ steps.check_build_flag.outputs.build_ready || '0' }}" == "1" ]; then
            echo "robo_test_status=skipped" >> $GITHUB_OUTPUT
            echo "â­ï¸  ä½¿ç”¨ä¹‹å‰çš„æ„å»ºäº§ç‰©ï¼Œè·³è¿‡ Test Lab æµ‹è¯•"
          else
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

            if [ ! -f "$APK_PATH" ]; then
              echo "âŒ APK not found at $APK_PATH"
              exit 1
            fi

            echo "ğŸ¤– å¼€å§‹ Firebase Test Lab - Random Crawl Test..."
            echo "è®¾å¤‡å‹å·: ${{ env.TEST_DEVICE_MODEL }}"
            echo "Android ç‰ˆæœ¬: ${{ env.TEST_DEVICE_VERSION }}"
            echo "è¯­è¨€ç¯å¢ƒ: ${{ env.TEST_LOCALE }}"
            echo "å±å¹•æ–¹å‘: ${{ env.TEST_ORIENTATION }}"

            # è®¾ç½®æœåŠ¡è´¦å·è®¤è¯
            echo ""
            echo "==== è®¾ç½® gcloud è®¤è¯ ===="
            if [ -z "$FIREBASE_SA_JSON" ]; then
              echo "âŒ FIREBASE_SERVICE_ACCOUNT_JSON æœªè®¾ç½®"
              exit 1
            fi

            # åˆ›å»ºä¸´æ—¶æœåŠ¡è´¦å·æ–‡ä»¶
            SA_FILE="${GITHUB_WORKSPACE}/gcloud_service_account.json"
            echo "$FIREBASE_SA_JSON" > "$SA_FILE"
            chmod 600 "$SA_FILE"

            # éªŒè¯ JSON æ ¼å¼
            python3 -m json.tool "$SA_FILE" > /dev/null || {
              echo "âŒ JSON æ ¼å¼æ— æ•ˆ"
              exit 1
            }

            # ä» JSON ä¸­æå– client_email
            CLIENT_EMAIL=$(python3 -c "import json; print(json.load(open('$SA_FILE'))['client_email'])")

            # æ¿€æ´»æœåŠ¡è´¦å·
            gcloud auth activate-service-account "$CLIENT_EMAIL" --key-file="$SA_FILE" || {
              echo "âŒ æ¿€æ´»æœåŠ¡è´¦å·å¤±è´¥"
              exit 1
            }

            # è®¾ç½®é¡¹ç›®
            gcloud config set project "${{ env.FIREBASE_PROJECT_ID }}" || {
              echo "âŒ è®¾ç½®é¡¹ç›®å¤±è´¥"
              exit 1
            }

            # éªŒè¯è®¤è¯
            echo ""
            echo "==== éªŒè¯ gcloud è®¤è¯ ===="
            ACTIVE_ACCOUNT=$(gcloud auth list --filter=status:ACTIVE --format="value(account)" || echo "")
            if [ -z "$ACTIVE_ACCOUNT" ]; then
              echo "âŒ æ²¡æœ‰æ´»åŠ¨çš„ gcloud è´¦æˆ·"
              exit 1
            fi
            echo "âœ… gcloud è®¤è¯æˆåŠŸ"
            echo "æ´»åŠ¨è´¦æˆ·: $ACTIVE_ACCOUNT"
            echo "é¡¹ç›®: $(gcloud config get-value project)"

            # æ£€æŸ¥ Cloud Testing API æ˜¯å¦å¯ç”¨
            echo ""
            echo "==== æ£€æŸ¥ Cloud Testing API ===="
            if ! gcloud services list --enabled --filter="name:testing.googleapis.com" --format="value(name)" | grep -q "testing.googleapis.com"; then
              echo "âš ï¸  Cloud Testing API æœªå¯ç”¨ï¼Œå°è¯•å¯ç”¨..."
              gcloud services enable testing.googleapis.com --project="${{ env.FIREBASE_PROJECT_ID }}" || {
                echo "âŒ æ— æ³•å¯ç”¨ Cloud Testing APIï¼Œè¯·æ‰‹åŠ¨åœ¨ Google Cloud Console ä¸­å¯ç”¨"
                echo "   é“¾æ¥: https://console.cloud.google.com/apis/library/testing.googleapis.com?project=${{ env.FIREBASE_PROJECT_ID }}"
              }
            else
              echo "âœ… Cloud Testing API å·²å¯ç”¨"
            fi

            # æ£€æŸ¥å­˜å‚¨æƒé™ï¼ˆFirebase Test Lab éœ€è¦ä¸Šä¼  APK åˆ° GCSï¼‰
            echo ""
            echo "==== æ£€æŸ¥å­˜å‚¨æƒé™ ===="
            echo "Firebase Test Lab éœ€è¦å°† APK ä¸Šä¼ åˆ° Google Cloud Storage"
            echo "æœåŠ¡è´¦å·: $CLIENT_EMAIL"
            echo "é¡¹ç›®: ${{ env.FIREBASE_PROJECT_ID }}"
            
            # å°è¯•åˆ—å‡ºå­˜å‚¨æ¡¶ï¼ˆæµ‹è¯•å­˜å‚¨æƒé™ï¼‰
            if gcloud storage buckets list --project="${{ env.FIREBASE_PROJECT_ID }}" --limit=1 > /dev/null 2>&1; then
              echo "âœ… å­˜å‚¨æƒé™æ£€æŸ¥é€šè¿‡"
            else
              echo "âš ï¸  æ— æ³•éªŒè¯å­˜å‚¨æƒé™ï¼ˆè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œç»§ç»­æ‰§è¡Œï¼‰"
            fi

            # è¿è¡Œ Robo Test (Random Crawl) - è‡ªåŠ¨æ¢ç´¢ UI
            echo ""
            echo "==== å¼€å§‹è¿è¡Œ Test Lab ===="
            
            # æ•è·å‘½ä»¤è¾“å‡ºç”¨äºé”™è¯¯åˆ†æ
            TEST_OUTPUT=$(gcloud firebase test android run \
              --app "$APK_PATH" \
              --type robo \
              --device model=${{ env.TEST_DEVICE_MODEL }},version=${{ env.TEST_DEVICE_VERSION }},locale=${{ env.TEST_LOCALE }},orientation=${{ env.TEST_ORIENTATION }} \
              --project ${{ env.FIREBASE_PROJECT_ID }} \
              --timeout 15m \
              --robo-directives "click_on_text=Login" \
              --robo-directives "click_on_text=Sign In" 2>&1)
            TEST_EXIT_CODE=$?
            
            # æ˜¾ç¤ºè¾“å‡º
            echo "$TEST_OUTPUT"
            
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "robo_test_status=passed" >> $GITHUB_OUTPUT
              echo "âœ… Random Crawl Test é€šè¿‡"
            else
              echo "robo_test_status=failed" >> $GITHUB_OUTPUT
              echo ""
              echo "âŒ Random Crawl Test å¤±è´¥ (é€€å‡ºç : $TEST_EXIT_CODE)"
              echo ""
              echo "=========================================="
              echo "æƒé™é”™è¯¯è§£å†³æ–¹æ¡ˆ"
              echo "=========================================="
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯å­˜å‚¨æƒé™é”™è¯¯
              if echo "$TEST_OUTPUT" | grep -qi "storage.objects.create\|storage\.objects\|does not have.*storage.*access\|Permission.*storage.*denied"; then
                echo "ğŸ” æ£€æµ‹åˆ°å­˜å‚¨æƒé™é”™è¯¯"
                echo ""
                echo "Firebase Test Lab éœ€è¦å°† APK ä¸Šä¼ åˆ° Google Cloud Storage"
                echo "æœåŠ¡è´¦å·éœ€è¦ä»¥ä¸‹å­˜å‚¨ç›¸å…³æƒé™ï¼š"
                echo ""
                echo "ğŸ“‹ è§£å†³æ–¹æ¡ˆï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š"
                echo ""
                echo "æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰ï¼šæ·»åŠ  Storage Admin è§’è‰²"
                echo "1. è®¿é—® IAM é¡µé¢ï¼š"
                echo "   https://console.cloud.google.com/iam-admin/iam?project=${{ env.FIREBASE_PROJECT_ID }}"
                echo ""
                echo "2. æ‰¾åˆ°æœåŠ¡è´¦å·: $CLIENT_EMAIL"
                echo ""
                echo "3. ç‚¹å‡»ç¼–è¾‘ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹è§’è‰²ï¼š"
                echo "   âœ… Storage Adminï¼ˆæ¨èï¼ŒåŒ…å«æ‰€æœ‰å­˜å‚¨æƒé™ï¼‰"
                echo "   âœ… Firebase Quality Adminï¼ˆå¿…éœ€ï¼Œç”¨äº Test Labï¼‰"
                echo "   âœ… Service Account Userï¼ˆå¿…éœ€ï¼‰"
                echo ""
                echo "4. ä¿å­˜å¹¶ç­‰å¾… 1-2 åˆ†é’Ÿè®©æƒé™ç”Ÿæ•ˆ"
                echo ""
                echo "æ–¹æ¡ˆ 2ï¼šå¦‚æœæ–¹æ¡ˆ 1 ä¸è¡Œï¼Œæ·»åŠ æ›´å¹¿æ³›çš„æƒé™"
                echo "   âœ… Storage Admin"
                echo "   âœ… Firebase Adminï¼ˆå®Œæ•´çš„ Firebase æƒé™ï¼‰"
                echo "   âœ… Service Account User"
                echo ""
                echo "æ–¹æ¡ˆ 3ï¼šç›´æ¥æˆäºˆå­˜å‚¨æ¡¶æƒé™ï¼ˆå¦‚æœçŸ¥é“å­˜å‚¨æ¡¶åç§°ï¼‰"
                echo "   å­˜å‚¨æ¡¶åç§°é€šå¸¸ç±»ä¼¼ï¼štest-lab-xxxxx-xxxxx"
                echo "   å¯ä»¥åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ‰¾åˆ°å­˜å‚¨æ¡¶è·¯å¾„"
                echo ""
              else
                echo "å¦‚æœçœ‹åˆ° '403: Not authorized' é”™è¯¯ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š"
                echo ""
                echo "1. è®¿é—® Google Cloud Console IAM é¡µé¢ï¼š"
                echo "   https://console.cloud.google.com/iam-admin/iam?project=${{ env.FIREBASE_PROJECT_ID }}"
                echo ""
                echo "2. æ‰¾åˆ°æœåŠ¡è´¦å·: $CLIENT_EMAIL"
                echo ""
                echo "3. ç‚¹å‡»ç¼–è¾‘ï¼ˆé“…ç¬”å›¾æ ‡ï¼‰ï¼Œæ·»åŠ ä»¥ä¸‹è§’è‰²ï¼š"
                echo "   - Firebase Quality Adminï¼ˆå¿…éœ€ï¼‰"
                echo "   - Storage Adminï¼ˆç”¨äºä¸Šä¼  APK åˆ° GCSï¼‰"
                echo "   - Firebase Adminï¼ˆå¦‚æœæ‰¾ä¸åˆ°å…¶ä»–è§’è‰²ï¼Œä½¿ç”¨è¿™ä¸ªï¼‰"
                echo "   - Service Account Userï¼ˆå¿…éœ€ï¼‰"
                echo ""
                echo "   æ³¨æ„ï¼šå¦‚æœæ‰¾ä¸åˆ° 'Cloud Testing Service Agent'ï¼Œå¯ä»¥è·³è¿‡ï¼Œ"
                echo "   ä½¿ç”¨ 'Firebase Admin' æˆ– 'Firebase Quality Admin' å³å¯"
                echo ""
              fi
              
              echo "4. å¯ç”¨ Cloud Testing APIï¼š"
              echo "   https://console.cloud.google.com/apis/library/testing.googleapis.com?project=${{ env.FIREBASE_PROJECT_ID }}"
              echo ""
              echo "5. ç­‰å¾… 1-2 åˆ†é’Ÿåé‡è¯•"
              echo ""
              echo "ğŸ’¡ æç¤ºï¼š"
              echo "   - Storage Object Admin å¯èƒ½ä¸å¤Ÿï¼Œå»ºè®®ä½¿ç”¨ Storage Admin"
              echo "   - æƒé™æ›´æ”¹éœ€è¦ 1-2 åˆ†é’Ÿæ‰èƒ½ç”Ÿæ•ˆ"
              echo "   - å¦‚æœé—®é¢˜æŒç»­ï¼Œæ£€æŸ¥æœåŠ¡è´¦å·æ˜¯å¦æœ‰é¡¹ç›®çº§åˆ«çš„æƒé™"
              echo "=========================================="
              # ä¸é€€å‡ºï¼Œå…è®¸å·¥ä½œæµç»§ç»­ï¼Œä½†æ ‡è®°ä¸ºå¤±è´¥
            fi

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "$SA_FILE"
          fi

      - name: å‘é€æµ‹è¯•å¤±è´¥é€šçŸ¥åˆ° Lark
        if: steps.robo_test.outputs.robo_test_status == 'failed'
        run: |
          VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2)
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âš ï¸ SmartAge App - æµ‹è¯•å¤±è´¥\\n\\næµ‹è¯•ç»“æœï¼š\\n- Firebase Test Lab - Random Crawl Test: ${{ steps.robo_test.outputs.robo_test_status || 'unknown' }}\\n\\næµ‹è¯•ä¿¡æ¯ï¼š\\n- è®¾å¤‡å‹å·: ${{ env.TEST_DEVICE_MODEL }}\\n- Android ç‰ˆæœ¬: ${{ env.TEST_DEVICE_VERSION }}\\n- è¯­è¨€ç¯å¢ƒ: ${{ env.TEST_LOCALE }}\\n- ç‰ˆæœ¬: $VERSION\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- æµ‹è¯•æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\nè¯·æŸ¥çœ‹ Firebase Console > Test Lab è·å–è¯¦ç»†æµ‹è¯•æŠ¥å‘Šï¼š\\nhttps://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_ID }}/testlab/histories\\n\\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ï¼š\\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

      - name: å‘é€æ„å»ºæˆåŠŸç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        if: success()
        run: |
          VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2)
          TEST_STATUS="${{ steps.robo_test.outputs.robo_test_status || 'unknown' }}"
          if [ "$TEST_STATUS" == "failed" ]; then
            TEST_MSG="âš ï¸ Firebase Test Lab - Random Crawl Test: å¤±è´¥ï¼ˆä½†å¯æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²ï¼‰"
          else
            TEST_MSG="âœ… Firebase Test Lab - Random Crawl Test: $TEST_STATUS"
          fi
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âœ… SmartAge App - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\\n\\næ„å»ºä¿¡æ¯ï¼š\\n- ç‰ˆæœ¬: $VERSION\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\næµ‹è¯•ç»“æœï¼š\\n- $TEST_MSG\\n\\nğŸ“‹ è¯·å‰å¾€ GitHub Actions æ‰¹å‡†éƒ¨ç½²ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\\n1. å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n2. æ‰¾åˆ° 'éƒ¨ç½²åˆ° Firebase App Distributionï¼ˆéœ€è¦æ‰¹å‡†ï¼‰' job\\n3. ç‚¹å‡» 'Review deployments' æŒ‰é’®\\n4. ç‚¹å‡» 'Approve and deploy' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\\n\\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\\n\\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

      - name: å‘é€æ„å»ºå¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2 || echo "unknown")
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âŒ SmartAge App - æ„å»ºå¤±è´¥ï¼\\n\\næ„å»ºä¿¡æ¯ï¼š\\n- ç‰ˆæœ¬: $VERSION\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

  check-deployment-approval:
    name: "æ£€æŸ¥éƒ¨ç½²æ‰¹å‡†çŠ¶æ€"
    runs-on: ubuntu-latest
    needs: build
    if: |
      needs.build.result == 'success'
    outputs:
      is_approved: ${{ steps.check.outputs.is_approved }}
      approver: ${{ steps.check.outputs.approver }}
    steps:
      - name: æ£€æŸ¥éƒ¨ç½²æ‰¹å‡†çŠ¶æ€
        id: check
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²æ‰¹å‡†æ£€æŸ¥"
          echo "=========================================="
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo "æ‰¹å‡†éƒ¨ç½²å‚æ•°: ${{ github.event.inputs.approve_deployment }}"
          echo ""

          # æ£€æŸ¥æ˜¯å¦æ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†æ‰¹å‡†é€‰é¡¹
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.approve_deployment }}" == "true" ]; then
            echo "is_approved=true" >> $GITHUB_OUTPUT
            echo "approver=${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "âœ… éƒ¨ç½²å·²è·å¾—æ‰¹å‡†"
            echo "æ‰¹å‡†äºº: ${{ github.actor }}"
            
            # æ£€æŸ¥æµ‹è¯•çŠ¶æ€å¹¶ç»™å‡ºè­¦å‘Š
            if [ "${{ needs.build.outputs.robo_test_status }}" == "failed" ]; then
              echo ""
              echo "âš ï¸  è­¦å‘Šï¼šæµ‹è¯•å¤±è´¥ï¼Œä½†å·²æ‰¹å‡†éƒ¨ç½²ï¼Œå°†ç»§ç»­æ‰§è¡Œ"
            fi
          else
            echo "is_approved=false" >> $GITHUB_OUTPUT
            echo "approver=" >> $GITHUB_OUTPUT
            if [ "${{ github.event_name }}" == "schedule" ]; then
              echo "â³ å®šæ—¶ä»»åŠ¡è§¦å‘ï¼Œç­‰å¾…æ‰‹åŠ¨æ‰¹å‡†éƒ¨ç½²"
              echo ""
              echo "ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
              echo "1. å‰å¾€å·¥ä½œæµé¡µé¢ï¼š"
              echo "   ${{ github.server_url }}/${{ github.repository }}/actions/workflows/flutter_firebase_deploy.yml"
              echo "2. ç‚¹å‡»å³ä¸Šè§’ 'Run workflow' æŒ‰é’®"
              echo "3. å‹¾é€‰ 'æ‰¹å‡†éƒ¨ç½²åˆ° Firebase (approve_deployment)' é€‰é¡¹"
              echo "4. ç‚¹å‡»ç»¿è‰²çš„ 'Run workflow' æŒ‰é’®"
              echo ""
              echo "â„¹ï¸  æ³¨æ„ï¼šéƒ¨ç½² job å°†è¢«è·³è¿‡ï¼Œç›´åˆ°æ‰‹åŠ¨æ‰¹å‡†"
            elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
              echo "â³ æ‰‹åŠ¨è§¦å‘æ„å»ºï¼Œä½†æœªå‹¾é€‰éƒ¨ç½²æ‰¹å‡†"
              echo "æç¤º: å¦‚éœ€éƒ¨ç½²ï¼Œè¯·é‡æ–°è§¦å‘å·¥ä½œæµå¹¶å‹¾é€‰ 'æ‰¹å‡†éƒ¨ç½²åˆ° Firebase (approve_deployment)' é€‰é¡¹"
            else
              echo "âŒ éƒ¨ç½²æœªè·å¾—æ‰¹å‡†"
            fi
          fi
          echo "=========================================="
          echo "âœ… æ‰¹å‡†æ£€æŸ¥å®Œæˆ"

      - name: å‘é€æ£€æŸ¥å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âŒ SmartAge App - æ£€æŸ¥éƒ¨ç½²æ‰¹å‡†çŠ¶æ€å¤±è´¥ï¼\\n\\nå¤±è´¥ä¿¡æ¯ï¼š\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

  notify-pending-approval:
    name: "é€šçŸ¥ç­‰å¾…éƒ¨ç½²æ‰¹å‡†"
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.result == 'success'
    steps:
      - name: å‘é€ç­‰å¾…æ‰¹å‡†é€šçŸ¥åˆ° Lark
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"â³ SmartAge App - æ„å»ºæˆåŠŸï¼Œç­‰å¾…éƒ¨ç½²æ‰¹å‡†\\n\\næ„å»ºä¿¡æ¯ï¼š\\n- ç‰ˆæœ¬: ${{ needs.build.outputs.app_version || 'unknown' }}\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\næµ‹è¯•ç»“æœï¼š\\n- Firebase Test Lab - Random Crawl Test: ${{ needs.build.outputs.robo_test_status || 'unknown' }}\\n\\nğŸ“‹ æ‰¹å‡†éƒ¨ç½²æ­¥éª¤ï¼ˆGitHub Environment å®¡æ‰¹ï¼‰ï¼š\\n\\n1ï¸âƒ£ å‰å¾€å½“å‰å·¥ä½œæµè¿è¡Œé¡µé¢\\n   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\n2ï¸âƒ£ æ‰¾åˆ° 'éƒ¨ç½²åˆ° Firebase App Distributionï¼ˆéœ€è¦æ‰¹å‡†ï¼‰' job\\n\\n3ï¸âƒ£ ç‚¹å‡» 'Review deployments' æŒ‰é’®\\n\\n4ï¸âƒ£ ç‚¹å‡» 'Approve and deploy' æŒ‰é’®æ‰¹å‡†éƒ¨ç½²\\n\\nğŸ’¡ æç¤ºï¼šåªæœ‰é…ç½®åœ¨ Environment ä¸­çš„ Required reviewers æ‰èƒ½æ‰¹å‡†\\n\\nå·¥ä½œæµè¿è¡Œ ID: ${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

  deploy-to-firebase:
    name: "éƒ¨ç½²åˆ° Firebase App Distributionï¼ˆéœ€è¦æ‰¹å‡†ï¼‰"
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'success'
    environment:
      name: firebase-production
      url: https://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_ID }}/appdistribution
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: æ˜¾ç¤ºæ‰¹å‡†ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "éƒ¨ç½²æ‰¹å‡†ä¿¡æ¯"
          echo "=========================================="
          echo "âœ… éƒ¨ç½²å·²é€šè¿‡ GitHub Environment å®¡æ‰¹"
          echo "å®¡æ‰¹äºº: ${{ github.actor }}"
          echo "è§¦å‘è€…: ${{ github.actor }}"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "æµ‹è¯•çŠ¶æ€: ${{ needs.build.outputs.robo_test_status || 'unknown' }}"
          if [ "${{ needs.build.outputs.robo_test_status }}" == "failed" ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæµ‹è¯•å¤±è´¥ï¼Œä½†å·²æ‰¹å‡†éƒ¨ç½²ï¼Œå°†ç»§ç»­æ‰§è¡Œ"
          fi
          echo "=========================================="

      - name: ä¸‹è½½ APK æ–‡ä»¶
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install firebase-tools
        run: npm install -g firebase-tools@latest

      - name: Write Firebase service account key
        env:
          FIREBASE_SA_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "$FIREBASE_SA_JSON" ]; then
            echo "âŒ FIREBASE_SERVICE_ACCOUNT_JSON is not set"
            echo "è¯·åœ¨ GitHub Secrets ä¸­æ·»åŠ  FIREBASE_SERVICE_ACCOUNT_JSON"
            exit 1
          fi
          echo "$FIREBASE_SA_JSON" > "${GITHUB_WORKSPACE}/firebase_service_account.json"
          chmod 600 "${GITHUB_WORKSPACE}/firebase_service_account.json"
          echo "âœ… Firebase service account key written"

          # éªŒè¯ JSON æ ¼å¼
          python3 -m json.tool "${GITHUB_WORKSPACE}/firebase_service_account.json" > /dev/null || {
            echo "âŒ JSON æ ¼å¼æ— æ•ˆ"
            exit 1
          }
          echo "âœ… JSON æ ¼å¼éªŒè¯é€šè¿‡"

      - name: éƒ¨ç½²åˆ° Firebase App Distributionï¼ˆä½¿ç”¨ Firebase CLIï¼‰
        id: deploy_firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/firebase_service_account.json
          FIREBASE_APP_ID: ${{ env.FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ env.FIREBASE_PROJECT_ID }}
        run: |
          set -e

          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"

          echo "==== æ£€æŸ¥ APK æ–‡ä»¶ ===="
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found at $APK_PATH"
            echo "Available files:"
            ls -la build/app/outputs/flutter-apk || true
            exit 1
          fi

          echo "âœ… APK found: $APK_PATH"
          ls -lh "$APK_PATH"

          echo ""
          echo "==== æ£€æŸ¥ç¯å¢ƒå˜é‡ ===="
          echo "GOOGLE_APPLICATION_CREDENTIALS: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "FIREBASE_APP_ID: $FIREBASE_APP_ID"
          echo "FIREBASE_PROJECT_ID: $FIREBASE_PROJECT_ID"

          if [ -z "$FIREBASE_APP_ID" ]; then
            echo "âŒ FIREBASE_APP_ID is not set"
            echo "è¯·åœ¨ GitHub Secrets ä¸­æ·»åŠ  FIREBASE_APP_ID"
            exit 1
          fi

          echo ""
          echo "==== Firebase CLI ç‰ˆæœ¬ ===="
          firebase --version

          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2)

          echo ""
          echo "==== ç‰ˆæœ¬ä¿¡æ¯ ===="
          echo "ç‰ˆæœ¬: $VERSION"
          echo "Commit: ${{ github.sha }}"
          echo "æ‰¹å‡†äºº: ${{ github.actor }}"

          # è·å–æäº¤ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          COMMIT_MESSAGE="N/A"
          if [ -n "${{ github.event.head_commit.message }}" ]; then
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          fi

          echo ""
          echo "==== å¼€å§‹ä¸Šä¼ åˆ° Firebase App Distribution ===="

          # éƒ¨ç½²åˆ° Firebase App Distribution
          firebase appdistribution:distribute "$APK_PATH" \
            --app "$FIREBASE_APP_ID" \
            --groups "${{ env.FIREBASE_GROUPS }}" \
            --project "$FIREBASE_PROJECT_ID" \
            --release-notes "ğŸ“± SmartAge Nurse App - è‡ªåŠ¨æ„å»º

          ğŸ“¦ ç‰ˆæœ¬: $VERSION
          ğŸ”– Commit: ${{ github.sha }}
          ğŸ“ æäº¤ä¿¡æ¯: $COMMIT_MESSAGE
          ğŸ‘¤ ä½œè€…: ${{ github.actor }}
          âœ… æ‰¹å‡†äºº: ${{ github.actor }}
          ğŸ•’ æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}
          âœ… å·²é€šè¿‡ GitHub Environment å®¡æ‰¹"

          echo ""
          echo "âœ… Firebase App Distribution ä¸Šä¼ æˆåŠŸï¼"
          echo "ğŸ“¦ ä¸Šä¼ ç‰ˆæœ¬: $VERSION"

      - name: Cleanup Firebase key
        if: always()
        run: rm -f "${GITHUB_WORKSPACE}/firebase_service_account.json" || true

      - name: å‘é€æœ€ç»ˆæ„å»ºæˆåŠŸé€šçŸ¥åˆ° Lark
        if: success()
        run: |
          VERSION=$(cat pubspec.yaml | grep 'version:' | cut -d ' ' -f 2)
          TEST_STATUS="${{ needs.build.outputs.robo_test_status || 'unknown' }}"
          if [ "$TEST_STATUS" == "failed" ]; then
            TEST_MSG="âš ï¸ Firebase Test Lab - Random Crawl Test: å¤±è´¥ï¼ˆä½†å·²æ‰¹å‡†éƒ¨ç½²ï¼‰"
          else
            TEST_MSG="âœ… Firebase Test Lab - Random Crawl Test: $TEST_STATUS"
          fi
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âœ… SmartAge App - æ„å»ºå’Œéƒ¨ç½²æˆåŠŸå®Œæˆï¼\\n\\næµ‹è¯•ç»“æœï¼š\\n- $TEST_MSG\\n\\næ„å»ºä¿¡æ¯ï¼š\\n- ç‰ˆæœ¬: $VERSION\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- æ‰¹å‡†äºº: ${{ github.actor }}\\n- éƒ¨ç½²æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\nAPK å·²æˆåŠŸéƒ¨ç½²åˆ° Firebase App Distributionã€‚\\næµ‹è¯•ç»„: ${{ env.FIREBASE_GROUPS }}\\n\\næŸ¥çœ‹æµ‹è¯•æŠ¥å‘Šï¼š\\nhttps://console.firebase.google.com/project/${{ env.FIREBASE_PROJECT_ID }}/testlab/histories\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"

      - name: å‘é€éƒ¨ç½²å¤±è´¥é€šçŸ¥åˆ° Lark
        if: failure()
        run: |
          curl -X POST "${{ env.LARK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âŒ SmartAge App - éƒ¨ç½²å¤±è´¥ï¼\\n\\néƒ¨ç½²ä¿¡æ¯ï¼š\\n- Commit: ${{ github.sha }}\\n- åˆ†æ”¯: ${{ github.ref_name }}\\n- ä½œè€…: ${{ github.actor }}\\n- å¤±è´¥æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')\\n\\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š\\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\næ­¤é€šçŸ¥ç”± GitHub Actions è‡ªåŠ¨å‘é€ã€‚\"
              }
            }"
